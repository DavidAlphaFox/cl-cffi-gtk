@c -----------------------------------------------------------------------------
@c File     : gtk-selectors.texi
@c License  : GNU General Public License (GPL)
@c Language : English
@c Author   : Dieter Kaiser
@c Date     : 23.06.2012
@c Revision : 30.06.2012
@c
@c Copyright (C) 2012 by Dieter Kaiser
@c -----------------------------------------------------------------------------

@menu
* Selecting Colors::
* Selecting Files::
* Selecting Fonts::
@end menu

@c -----------------------------------------------------------------------------
@node Selecting Colors, Selecting Files, Top, Top
@section Selecting Colors

@c -----------------------------------------------------------------------------
@subsection Representing Colors

Colors are represented as a structure of the type @code{GdkRGBA}, which is
defined in the library GDK.  The stucture has the properties @code{red},
@code{green}, @code{blue}, and @code{alpha} to represent rgba colors.  It is
based on cairo's way to deal with colors and mirrors its behavior.  All values
are in the range from @code{0.0d0} to @code{1.0d0} inclusive.  So the color
@code{(0.0d0, 0.0d0, 0.0d0, 0.0d0)} represents transparent black and
@code{(1.0d0, 1.0d0, 1.0d0, 1.0d0)} is opaque white.  Other values will be
clamped to this range when drawing.

To create a representation of the color red use
@code{(make-gdk-rgba :red 1.0d0)}.  Alternatively, the function
@code{gdk-rgba-parse} parses a textual representation of a color, filling in the
red, green, blue and alpha fields of the @code{GdkRGBA} structure.  The string
can be either one of:

@itemize
@item A standard name (Taken from the X11 rgb.txt file).
@item A hex value in the form 'rgb' 'rrggbb' 'rrrgggbbb' or 'rrrrggggbbbb'
@item A RGB color in the form 'rgb(r,g,b)' (In this case the color will have
      full opacity)
@item A RGBA color in the form 'rgba(r,g,b,a)'
@end itemize

Where 'r', 'g', 'b' and 'a' are respectively the red, green, blue and alpha
color values. In the last two cases, r g and b are either integers in the
range 0 to 255 or precentage values in the range 0% to 100%, and a is a
floating point value in the range 0 to 1.

Conversely, the function @code{gdk-rgba-to-string} returns a textual
specification of the rgba color in the form rgb (r, g, b) or
rgba (r, g, b, a), where 'r', 'g', 'b' and 'a' represent the red, green,
blue and alpha values respectively.  r, g, and b are represented as integers
in the range 0 to 255, and a is represented as floating point value in the
range 0 to 1.

These string forms are string forms those supported by the CSS3 colors
module, and can be parsed by gdk_rgba_parse().

Note that this string representation may loose some precision, since r, g
and b are represented as 8-bit integers. If this is a concern, you should
use a different representation.

A simple example is the representation of the color red, which can be created
with @code{(gdk-rgba-parse "Red"} from a string and converted back to a textual
with (gdk-rgba-to-string (gdk-rgba-parse "Red")).  The result of the last
function is @code{"rgba(255,0,0,0)"}.

Note, that GTK+ knows a second representation of colors as a structure
of type @code{GdkColor}.  The implementation is semilar.  The widgets for
choosing a color know both representations.

@c -----------------------------------------------------------------------------
@subsection Color Button and Color Chooser Dialog

@ifnotinfo
@float Figure, figure-color-button
@caption{Color Selecting Dialog}
@center @image{figures/color-button, 327pt}
@end float
@end ifnotinfo

The @code{GtkColorButton} is a button which displays the currently selected
color and allows to open a color selection dialog to change the color.  It is
suitable widget for selecting a color in a preference dialog.  It
implements the @code{GtkColorChooser} interface.

@ref{example-color-button} shows a simple implementation of a
@code{GtkColorButton}.  The example displays a button with the predefined color
gray.  When clicking the button, a color selection dialog is opened.  The dialog
is shown in @ref{figure-color-button}.

@float Example, example-color-button
@caption{Color Button}
@end float
@verbatim
(let ((color (gdk-rgba-parse "Gray")))
  (defun example-color-button ()
    (within-main-loop
      (let ((window (make-instance 'gtk-window
                                   :title "Example Color Button"
                                   :border-width 12
                                   :default-width 250
                                   :default-height 200))
            (button (make-instance 'gtk-color-button
                                   :rgba color)))
        (g-signal-connect window "destroy"
                          (lambda (widget)
                            (declare (ignore widget))
                            (leave-gtk-main)))
        (g-signal-connect button "color-set"
           (lambda (widget)
             (let ((rgba (gtk-color-chooser-get-rgba widget)))
               (format t "Selected color is ~A~%"
                       (gdk-rgba-to-string rgba)))))
        (gtk-container-add window button)
        (gtk-widget-show-all window)))))
@end verbatim

The @code{GtkColorChooserDialog} widget is a dialog for choosing a color.  It
implements the @code{GtkColorChooser} interface.  To provide a dialog in the
@code{GtkColorChooserDialog} the @code{GtkColorChooserWidget} is used.

By default, the chooser presents a prefined palette of colors, plus a small
number of settable custom colors.  It is also possible to select a different
color with the single-color editor.  To enter the single-color editing mode, use
the context menu of any color of the palette, or use the '+' button to add a new
custom color.

The chooser automatically remembers the last selection, as well as custom
colors.

To change the initially selected color, use @code{gtk-color-chooser-set_rgba}.
To get the selected color use @code{gtk-color-chooser-get-rgba}.

@ref{example-color-chooser-dialog} shows how to replace the default color
palette and the default gray palette with the function
@code{gtk-color-chooser-add-palette}.

@ifnotinfo
@float Figure, figure-color-chooser-dialog
@caption{Color Selecting Dialog with a custom color and gray palette}
@center @image{figures/color-chooser-dialog, 292pt}
@end float
@end ifnotinfo

@float Example, example-color-chooser-dialog
@caption{Color Chooser Dialog}
@end float
@verbatim
(let ((color (gdk-rgba-parse "Blue"))
      ;; Color palette with 4 rgba colors
      (palette1 (list (gdk-rgba-parse "Red")
                      (gdk-rgba-parse "Yellow")
                      (gdk-rgba-parse "Blue")
                      (gdk-rgba-parse "Green")))
      ;; Gray palette with 3 rgba grays
      (palette2 (list (gdk-rgba-parse "White")
                      (gdk-rgba-parse "Gray")
                      (gdk-rgba-parse "Black"))))
  (defun drawing-area-event (widget event area)
    (declare (ignore widget))
    (let ((handled nil))
      (when (eql (gdk-event-type event) :button-press)
        (let ((dialog (make-instance 'gtk-color-chooser-dialog
                                      :color color
                                      :use-alpha nil)))
          (setq handled t)
          ;; Add a custom palette to the dialog
          (gtk-color-chooser-add-palette dialog :vertical 1 palette1)
          ;; Add a second coustom palette to the dialog
          (gtk-color-chooser-add-palette dialog :vertical 1 palette2)
          ;; Run the color chooser dialog
          (let ((response (gtk-dialog-run dialog)))
            (when (eql response :ok)
              (setq color (gtk-color-chooser-get-rgba dialog)))
            ;; Set the color of the area widget
            (gtk-widget-override-background-color area :normal color)
            ;; Destroy the color chooser dialog
            (gtk-widget-destroy dialog))))
      handled))

  (defun example-color-chooser-dialog ()
    (within-main-loop
      (let ((window (make-instance 'gtk-window
                                   :title "Example Color Chooser Dialog"
                                   :default-width 300))
            (area (make-instance 'gtk-drawing-area)))
        (g-signal-connect window "destroy"
                          (lambda (widget)
                            (declare (ignore widget))
                            (leave-gtk-main)))
        (gtk-widget-override-background-color area :normal color)
        (gtk-widget-set-events area :button-press-mask)
        (g-signal-connect area "event"
                          (lambda (widget event)
                            (drawing-area-event widget event area)))
        (gtk-container-add window area)
        (gtk-widget-show-all window)))))
@end verbatim

@c -----------------------------------------------------------------------------
@node Selecting Files, Selecting Fonts, Selecting Colors, Top
@section Selecting Files

@ifnotinfo
@float Figure, figure-file-chooser-dialog
@caption{File Chooser Dialog}
@center @image{figures/file-chooser-dialog, 379pt}
@end float
@end ifnotinfo

@code{GtkFileChooser} is an interface that can be implemented by file selection
widgets. In GTK+, the main objects that implement this interface are
@code{GtkFileChooserWidget}, @code{GtkFileChooserDialog}, and
@code{GtkFileChooserButton}. You do not need to write an object that implements
the @code{GtkFileChooser} interface unless you are trying to adapt an existing
file selector to expose a standard programming interface.

@code{GtkFileChooser} allows for shortcuts to various places in the filesystem.
In the default implementation these are displayed in the left pane. It may be a
bit confusing at first that these shortcuts come from various sources and in
various flavours, so lets explain the terminology here:

@table @emph
@item Bookmarks
     are created by the user, by dragging folders from the right pane to the
     left pane, or by using the "Add". Bookmarks can be renamed and deleted
     by the user.

@item Shortcuts
     can be provided by the application or by the underlying filesystem
     abstraction (e.g. both the gnome-vfs and the Windows filesystems provide
     "Desktop" shortcuts). Shortcuts cannot be modified by the user.

@item Volumes
     are provided by the underlying filesystem abstraction. They are the
     "roots" of the filesystem.
@end table

@need 800
@noindent
@b{File Names and Encodings}

When the user is finished selecting files in a @code{GtkFileChooser}, your
program can get the selected names either as filenames or as URIs. For URIs,
the normal escaping rules are applied if the URI contains non-ASCII characters.
However, filenames are always returned in the character set specified by the
@code{G_FILENAME_ENCODING} environment variable. Please see the Glib
documentation for more details about this variable.

@b{Note:}
This means that while you can pass the result of
@code{gtk-file-chooser-get-filename} to open(2) or fopen(3), you may not be able
to directly set it as the text of a @code{GtkLabel} widget unless you convert it
first to UTF-8, which all GTK+ widgets expect. You should use
@code{g-filename-to-utf8} to convert filenames into strings that can be passed
to GTK+ widgets.

@need 800
@noindent
@b{Adding a Preview Widget}

You can add a custom preview widget to a file chooser and then get
notification about when the preview needs to be updated. To install a
preview widget, use @code{gtk-file-chooser-set-preview-widget}. Then, connect
to the "update-preview" signal to get notified when you need to update the
contents of the preview.

Your callback should use @code{gtk-file-chooser-get-preview-filename} to see
what needs previewing.  Once you have generated the preview for the
corresponding file, you must call
@code{gtk-file-chooser-set-preview-widget-active} with a boolean flag that
indicates whether your callback could successfully generate a preview.

@need 800
@noindent
@b{Adding Extra Widgets}

You can add extra widgets to a file chooser to provide options that are not
present in the default design.  For example, you can add a toggle button to
give the user the option to open a file in read-only mode. You can use
@code{gtk-file-chooser-set-extra-widget} to insert additional widgets in a file
chooser.

@b{Note:}
If you want to set more than one extra widget in the file chooser, you can use
a container such as a @code{GtkVBox} or a @code{GtkTable} and include your
widgets in it.  Then, set the container as the whole extra widget.

@code{GtkFileChooserDialog} is a dialog box suitable for use with "File/Open" or
"File/Save as" commands.  This widget works by putting a
@code{GtkFileChooserWidget} inside a @code{GtkDialog}.  It exposes the
@code{GtkFileChooserIface} interface, so you can use all of the
@code{GtkFileChooser} functions on the file chooser dialog as well as those for
@code{GtkDialog}.

Note that @code{GtkFileChooserDialog} does not have any methods of its own.
Instead, you should use the functions that work on a @code{GtkFileChooser}.

@subheading Setting up a file chooser dialog

The enumeration @code{GtkFileChooserAction} describes whether a
@code{GtkFileChooser} is being used to open existing files or to save to a
possibly new file.  These are the cases in which you may need to use a
@code{GtkFileChooserDialog}.

@itemize
@item To select a file for opening, as for a File/Open command.  Use
      the keyword @code{:open} for the slot @code{:action}, when creating
      a file chooser dialog.
@item To save a file for the first time, as for a File/Save command.  Use
      the keyword @code{:save}, and suggest a name such as "Untitled" with
      @code{gtk-file-chooser-set-current-name}.
@item To save a file under a different name, as for a File/Save As command.
      Use the keyword @code{:save}, and set the existing filename with
      @code{gtk-file-chooser-set-file-name}.
@item To choose a folder instead of a file. Use the keyword
      @code{select-folder}.
@end itemize

@subheading Response Codes

@code{GtkFileChooserDialog} inherits from @code{GtkDialog}, so buttons that go
in its action area have response codes such as @code{:accept} and @code{:canel}.
For example, you could create a file chooser dialog as follows:

@example
(let ((dialog (gtk-file-chooser-dialog-new "Speichern"
                                           nil
                                           :save
                                           "gtk-save" :accept
                                           "gtk-cancel" :cancel)))
[...]
@end example

This will create buttons for "Cancel" and "Save" that use stock response
identifiers from @code{GtkResponseType}. For most dialog boxes you can use your
own custom response codes rather than the ones in @code{GtkResponseType}, but
@code{GtkFileChooserDialog} assumes that its "accept"-type action, e.g. an
"Open" or "Save" button, will have one of the following response codes
@code{:accept}, @code{:ok}, @code{:yes}, or @code{:apply}.

This is because @code{GtkFileChooserDialog} must intercept responses and switch
to folders if appropriate, rather than letting the dialog terminate - the
implementation uses these known response codes to know which responses can be
blocked if appropriate.  To summarize, make sure you use a stock response code
when you use @code{GtkFileChooserDialog} to ensure proper operation.

@ref{example-file-chooser-dialog} shows an example for selecting a file for
save.  The dialog is shown in @ref{figure-file-chooser-dialog}.

@float Example, example-file-chooser-dialog
@caption{File Chooser Dialog}
@end float
@verbatim
(defun example-file-chooser-dialog ()
  (within-main-loop
    (let ((window (make-instance 'gtk-window
                                 :title "Example File Chooser Dialog"
                                 :type :toplevel
                                 :border-width 12
                                 :default-width 300
                                 :default-height 100))
          (button (make-instance 'gtk-button
                                 :label "Select a file for save ..."
                                 :image
                                 (gtk-image-new-from-stock "gtk-save"
                                                           :button))))
      ;; Handle the signal "destroy" for the window.
      (g-signal-connect window "destroy"
                        (lambda (widget)
                          (declare (ignore widget))
                          (leave-gtk-main)))
      ;; Handle the signal "clicked" for the button.
      (g-signal-connect button "clicked"
         (lambda (widget)
           (declare (ignore widget))
           (let ((dialog (gtk-file-chooser-dialog-new "Speichern"
                                                      nil
                                                      :save
                                                      "gtk-save" :accept
                                                      "gtk-cancel" :cancel)))
             (when (eq (gtk-dialog-run dialog) :accept)
               (format t "Saved to file ~A~%"
                       (gtk-file-chooser-filename dialog)))
             (gtk-widget-destroy dialog))))
      (gtk-container-add window button)
      (gtk-widget-show-all window))))
@end verbatim

The @code{GtkFileChooserButton} is a widget that lets the user select a file.
It implements the @code{GtkFileChooser} interface.  Visually, it is a file name
with a button to bring up a @code{GtkFileChooserDialog}.  The user can then use
that dialog to change the file associated with that button.

@ref{example-file-chooser-button} shows an example for a file chooser button
to open a file.

@float Example, example-file-chooser-button
@caption{File Chooser Button}
@end float
@verbatim
(defun example-file-chooser-button ()
  (within-main-loop
    (let ((window (make-instance 'gtk-window
                                 :title "Example File Chooser Button"
                                 :type :toplevel
                                 :border-width 12
                                 :default-width 300
                                 :default-height 100))
          (button (make-instance 'gtk-file-chooser-button
                                 :action :open)))
      (g-signal-connect window "destroy"
                        (lambda (widget)
                          (declare (ignore widget))
                          (leave-gtk-main)))
      (g-signal-connect button "file-set"
                        (lambda (widget)
                          (declare (ignore widget))
                          (format t "File set: ~A~%"
                                  (gtk-file-chooser-filename button))))
      (gtk-container-add window button)
      (gtk-widget-show-all window))))
@end verbatim

@c -----------------------------------------------------------------------------
@node Selecting Fonts, , Selecting Files, Top
@section Selecting Fonts

@ifnotinfo
@float Figure, figure-font-chooser-widget
@caption{Font Chooser Dialog}
@center @image{figures/font-chooser-dialog, 433pt}
@end float
@end ifnotinfo

The @code{GtkFontChooserWidget} widget lists the available fonts, styles and
sizes, allowing the user to select a font.  It is used in the
@code{GtkFontChooserDialog} widget to provide a dialog box for selecting fonts.

The @code{GtkFontChooserDialog} widget is a dialog for selecting a font.  It
implements the @code{GtkFontChooser} interface.

To set the font which is initially selected, use
@code{gtk-font-chooser-set-font} or @code{gtk-font-chooser-set-font-desc}.

To get the selected font use @code{gtk-font-chooser-get-font} or
@code{gtk-font-chooser-get-font-desc}.

To change the text which is shown in the preview area, use
@code{gtk-font-chooser-set-preview-text()}.

The @code{GtkFontButton} is a button which displays the currently selected font
and allows to open a font chooser dialog to change the font.  It is a suitable
widget for selecting a font in a preference dialog.

@float Example, example-font-button
@caption{Font Chooser Dialog with a filter to select fonts}
@end float
@verbatim
(defun font-filter (family face)
  (declare (ignore face))
  (member (pango-font-family-get-name family)
          '("Sans" "Serif")
          :test #'equal))

(defun example-font-button ()
  (within-main-loop
    (let ((window (make-instance 'gtk-window
                                 :title "Example Font Chooser Button"
                                 :type :toplevel
                                 :border-width 12
                                 :default-width 300
                                 :default-height 100))
          (button (make-instance 'gtk-font-button)))
      (g-signal-connect window "destroy"
                        (lambda (widget)
                          (declare (ignore widget))
                          (leave-gtk-main)))
      ;; Set a filter function to select fonts for the font chooser
      (gtk-font-chooser-set-filter-func button #'font-filter)
      (g-signal-connect button "font-set"
         (lambda (widget)
           (declare (ignore widget))
           (format t "Font is set:~%")
           (format t "   Font name   : ~A~%"
                   (gtk-font-chooser-get-font button))
           (format t "   Font family : ~A~%"
                   (pango-font-family-get-name
                     (gtk-font-chooser-get-font-family button)))
           (format t "   Font face   : ~A~%"
                   (pango-font-face-get-face-name
                     (gtk-font-chooser-get-font-face button)))
           (format t "   Font size   : ~A~%"
                   (gtk-font-chooser-get-font-size button))))
      (gtk-container-add window button)
      (gtk-widget-show-all window))))
@end verbatim



